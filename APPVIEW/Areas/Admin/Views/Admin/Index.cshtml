
@{
    ViewData["Title"] = "Home-Admin";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
}

<div class="container-xxl flex-grow-1 container-p-y">
    <div class="row gy-4">
        <!-- Transactions -->
    @*    <div class="col-lg-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="card-title m-0 me-2">Transactions</h5>
                        <div class="dropdown">
                            <button class="btn p-0"
                                    type="button"
                                    id="transactionID"
                                    data-bs-toggle="dropdown"
                                    aria-haspopup="true"
                                    aria-expanded="false">
                                <i class="mdi mdi-dots-vertical mdi-24px"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end" aria-labelledby="transactionID">
                                <a class="dropdown-item" href="javascript:void(0);">Refresh</a>
                                <a class="dropdown-item" href="javascript:void(0);">Share</a>
                                <a class="dropdown-item" href="javascript:void(0);">Update</a>
                            </div>
                        </div>
                    </div>
                    <p class="mt-3"><span class="fw-medium">Total 48.5% growth</span> 😎 this month</p>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3 col-6">
                            <div class="d-flex align-items-center">
                                <div class="avatar">
                                    <div class="avatar-initial bg-primary rounded shadow">
                                        <i class="mdi mdi-trending-up mdi-24px"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <div class="small mb-1">Sales</div>
                                    <h5 class="mb-0">245k</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="d-flex align-items-center">
                                <div class="avatar">
                                    <div class="avatar-initial bg-success rounded shadow">
                                        <i class="mdi mdi-account-outline mdi-24px"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <div class="small mb-1">Customers</div>
                                    <h5 class="mb-0">12.5k</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="d-flex align-items-center">
                                <div class="avatar">
                                    <div class="avatar-initial bg-warning rounded shadow">
                                        <i class="mdi mdi-cellphone-link mdi-24px"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <div class="small mb-1">Product</div>
                                    <h5 class="mb-0">1.54k</h5>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="d-flex align-items-center">
                                <div class="avatar">
                                    <div class="avatar-initial bg-info rounded shadow">
                                        <i class="mdi mdi-currency-usd mdi-24px"></i>
                                    </div>
                                </div>
                                <div class="ms-3">
                                    <div class="small mb-1">Revenue</div>
                                    <h5 class="mb-0">$88k</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>*@
      @*  <div class="col-xl-12 col-md-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between">
                        <h5 class="mb-1">Trending Products</h5>
                    </div>
                </div>
                <div class="card-body">
                    <div id="container">*@
                        @* <canvas id="trendingProductsChart"></canvas> *@
                      @*  <canvas id="weeklyChartview"></canvas>
                    </div>
                </div>
            </div>
        </div>*@
        <!--/ Transactions -->
        <!-- Weekly Overview Chart -->
        <div class="col-xl-6 col-md-6">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between">
                        <h5 class="mb-1">Weekly Overview</h5>
                    </div>
                </div>
                <div class="card-body">
                    <div id="container">
                        <canvas id="weeklyChart"></canvas>
                    </div>

                </div>
            </div>
        </div>


        <!--/ Weekly Overview Chart -->
        <!-- Total Earnings -->

        <div class="col-xl-6 col-md-6">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between">
                        <h5 class="mb-1">Total Earnings Chart</h5>
                        <div class="dropdown">
                            <select id="select" class="form-control" style="width: 100%">
                                @for (int year = DateTime.Now.Year; year >= 2015; year--)
                                {
                                    <option value="@year">@year</option>
                                }
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="container">
                        <canvas id="revenueChart"></canvas>
                    </div>  
                </div>
            </div>
        </div>
        <!-- Sales by Countries -->
        <!-- Thêm ID để dễ dàng truy cập thông qua JavaScript -->
        <div class="col-xl-6 col-md-6">
            <div class="card">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h5 class="card-title m-0 me-2">Top Trending</h5>
                    <div class="dropdown">
                        <button class="btn p-0"
                                type="button"
                                id="saleStatus"
                                data-bs-toggle="dropdown"
                                aria-haspopup="true"
                                aria-expanded="false">
                            <i class="mdi mdi-dots-vertical mdi-24px"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end" aria-labelledby="saleStatus">
                            <a class="dropdown-item" href="javascript:void(0);" onclick="sortBy('quantity')">By quantity</a>
                            <a class="dropdown-item" href="javascript:void(0);" onclick="sortBy('earnings')">By money</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="d-flex flex-wrap justify-content-between align-items-center mb-4">
                        <!-- HTML cho hiển thị dữ liệu -->
                        <table class="table" id="productTable">
                            <thead>
                                <tr>
                                    <th>Image Product</th>
                                    <th>Product Name</th>
                                    <th>Quantity Sold</th>
                                    <th>Total Earnings</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <!--/ Sales by Countries -->
        <!-- Deposit / Withdraw -->
        <div class="col-xl-8" style="visibility:hidden">
            <div class="card h-100">
                <div class="card-body row g-2">
                    <div class="col-12 col-md-6 card-separator pe-0 pe-md-3">
                        <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
                            <h5 class="m-0 me-2">Deposit</h5>
                            <a class="fw-medium" href="javascript:void(0);">View all</a>
                        </div>
                        <div class="pt-2">
                            <ul class="p-0 m-0">
                                <li class="d-flex mb-4 align-items-center pb-2">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="../assets/img/icons/payments/gumroad.png"
                                             class="img-fluid"
                                             alt="gumroad"
                                             height="30"
                                             width="30" />
                                    </div>
                                    <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <h6 class="mb-0">Gumroad Account</h6>
                                            <small>Sell UI Kit</small>
                                        </div>
                                        <h6 class="text-success mb-0">+$4,650</h6>
                                    </div>
                                </li>
                                <li class="d-flex mb-4 align-items-center pb-2">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="../assets/img/icons/payments/mastercard-2.png"
                                             class="img-fluid"
                                             alt="mastercard"
                                             height="30"
                                             width="30" />
                                    </div>
                                    <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <h6 class="mb-0">Mastercard</h6>
                                            <small>Wallet deposit</small>
                                        </div>
                                        <h6 class="text-success mb-0">+$92,705</h6>
                                    </div>
                                </li>
                                <li class="d-flex mb-4 align-items-center pb-2">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="../assets/img/icons/payments/stripes.png"
                                             class="img-fluid"
                                             alt="stripes"
                                             height="30"
                                             width="30" />
                                    </div>
                                    <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <h6 class="mb-0">Stripe Account</h6>
                                            <small>iOS Application</small>
                                        </div>
                                        <h6 class="text-success mb-0">+$957</h6>
                                    </div>
                                </li>
                                <li class="d-flex mb-4 align-items-center pb-2">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="../assets/img/icons/payments/american-bank.png"
                                             class="img-fluid"
                                             alt="american"
                                             height="30"
                                             width="30" />
                                    </div>
                                    <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <h6 class="mb-0">American Bank</h6>
                                            <small>Bank Transfer</small>
                                        </div>
                                        <h6 class="text-success mb-0">+$6,837</h6>
                                    </div>
                                </li>
                                <li class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="../assets/img/icons/payments/citi.png"
                                             class="img-fluid"
                                             alt="citi"
                                             height="30"
                                             width="30" />
                                    </div>
                                    <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <h6 class="mb-0">Bank Account</h6>
                                            <small>Wallet deposit</small>
                                        </div>
                                        <h6 class="text-success mb-0">+$446</h6>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="col-12 col-md-6 ps-0 ps-md-3 mt-3 mt-md-2">
                        <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
                            <h5 class="m-0 me-2">Withdraw</h5>
                            <a class="fw-medium" href="javascript:void(0);">View all</a>
                        </div>
                        <div class="pt-2">
                            <ul class="p-0 m-0">
                                <li class="d-flex mb-4 align-items-center pb-2">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="../assets/img/icons/brands/google.png"
                                             class="img-fluid"
                                             alt="google"
                                             height="30"
                                             width="30" />
                                    </div>
                                    <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <h6 class="mb-0">Google Adsense</h6>
                                            <small>Paypal deposit</small>
                                        </div>
                                        <h6 class="text-danger mb-0">-$145</h6>
                                    </div>
                                </li>
                                <li class="d-flex mb-4 align-items-center pb-2">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="../assets/img/icons/brands/github.png"
                                             class="img-fluid"
                                             alt="github"
                                             height="30"
                                             width="30" />
                                    </div>
                                    <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <h6 class="mb-0">Github Enterprise</h6>
                                            <small>Security &amp; compliance</small>
                                        </div>
                                        <h6 class="text-danger mb-0">-$1870</h6>
                                    </div>
                                </li>
                                <li class="d-flex mb-4 align-items-center pb-2">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="../assets/img/icons/brands/slack.png"
                                             class="img-fluid"
                                             alt="slack"
                                             height="30"
                                             width="30" />
                                    </div>
                                    <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <h6 class="mb-0">Upgrade Slack Plan</h6>
                                            <small>Debit card deposit</small>
                                        </div>
                                        <h6 class="text-danger mb-0">$450</h6>
                                    </div>
                                </li>
                                <li class="d-flex mb-4 align-items-center pb-2">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="../assets/img/icons/payments/digital-ocean.png"
                                             class="img-fluid"
                                             alt="digital"
                                             height="30"
                                             width="30" />
                                    </div>
                                    <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <h6 class="mb-0">Digital Ocean</h6>
                                            <small>Cloud Hosting</small>
                                        </div>
                                        <h6 class="text-danger mb-0">-$540</h6>
                                    </div>
                                </li>
                                <li class="d-flex align-items-center">
                                    <div class="flex-shrink-0 me-3">
                                        <img src="../assets/img/icons/brands/aws.png"
                                             class="img-fluid"
                                             alt="aws"
                                             height="30"
                                             width="30" />
                                    </div>
                                    <div class="d-flex w-100 flex-wrap align-items-center justify-content-between gap-2">
                                        <div class="me-2">
                                            <h6 class="mb-0">AWS Account</h6>
                                            <small>Choosing a Cloud Platform</small>
                                        </div>
                                        <h6 class="text-danger mb-0">-$21</h6>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Deposit / Withdraw -->

        <!--/Script xử lí -->

        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

        <script>
            let yearlyChart;
            var weeklyChart;
            var trendingProductsChart;

            $(document).ready(function () {
                // Khởi tạo biểu đồ ban đầu

                // Mặc định chọn năm hiện tại
                var currentYear = new Date().getFullYear();

                // var currentDay = new Date();


                $('#select').val(currentYear);

                if (yearlyChart) {
                    yearlyChart.destroy();
                }

                // Gọi hàm vẽ biểu đồ khi trang web được tải
                DrawChartForYear(currentYear);
                DrawWeeklyOverviewChart();
                DrawTrendingProducts();
                // Gọi hàm vẽ biểu đồ khi có sự kiện thay đổi năm
                $('#select').on('change', function () {
                    var selectedYear = $(this).val();
                    DrawChartForYear(selectedYear);
                });

                // Hàm vẽ biểu đồ với dữ liệu từ API
                function DrawChart(data) {

                    // Xoá bảng cữ  (nếu tồn tại)
                    if (yearlyChart) {
                        yearlyChart.destroy();
                    }
                    const ctx = document.getElementById('revenueChart').getContext('2d');
                    // Mảng chứa giá trị của 12 tháng
                    var monthsData = new Array(12).fill(0);

                    // Ánh xạ dữ liệu từ API vào mảng đầy đủ của 12 tháng
                    data.values.forEach(function (value, index) {
                        // Tháng được trả về từ API là 1-indexed, chuyển về 0-indexed
                        var a = data.labels[index] - 1;

                        monthsData[a] = value;
                    });

                    yearlyChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                            datasets: [{
                                label: data.label,
                                data: monthsData,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }


                // Hàm gọi API và vẽ biểu đồ cho năm được chọn
                function DrawChartForYear(selectedYear) {
                    // Gửi yêu cầu Ajax để lấy dữ liệu
                    $.ajax({
                        url: 'https://localhost:7042/api/Chart/' + selectedYear,
                        method: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            // console.log(data);
                            // Nếu có dữ liệu từ API, gọi hàm để vẽ biểu đồ
                            if (data && data.values && data.label) {
                                DrawChart(data);
                            } else {
                                console.error('Invalid data received from API');
                            }
                        },
                        error: function (error) {
                            console.error('Error fetching data:', error);
                        }
                    });
                }


                function DrawWeeklyChart(data) {
                    // var currentDay = new Date('12/7/2023');
                    var currentDay = new Date();

                    const ctx = document.getElementById('weeklyChart').getContext('2d');
                    if (weeklyChart) {
                        weeklyChart.destroy();
                    }

                    // Mảng chứa giá trị của 7 ngày gần nhất
                    var dayData = new Array(7).fill(0);

                    // Mảng chứa nhãn của 7 ngày gần nhất với định dạng ngày/tháng
                    var labels = [];
                    for (var i = 6; i >= 0; i--) {
                        var date = new Date(currentDay);
                        date.setDate(currentDay.getDate() - i);

                        var day = date.getDate();
                        var month = date.getMonth() + 1;

                        // Định dạng ngày và tháng thành "dd/mm" và thêm vào mảng labels
                        var formattedDate = `${day < 10 ? '0' : ''}${day}/${month < 10 ? '0' : ''}${month}`;
                        labels.push(formattedDate);
                    }

                    var z = labels[0].slice(0, 2);
                    // console.log('Begin Date:' + z);
                    var dayIndex = 0;
                    var biengancuaIndex = 0;
                    // Ánh xạ dữ liệu từ API vào mảng của 7 ngày gần nhất
                    data.values.forEach(
                        function (value, index) {
                            // 25/11
                            var day = data.labels[index]; // 11/25/2023 hoặc 1/12/2023 hoặc 12/01/2023
                            var daydate;

                            // Kiểm tra định dạng dd/mm/yyyy
                            if (day.length === 10) {
                                daydate = day.slice(3, 5); // Lấy ngày từ vị trí 3 đến 4 trong chuỗi
                            }
                            // Kiểm tra định dạng d/mm/yyyy
                            else if (day.length === 9 && day.indexOf("/") === 1) {
                                daydate = day.slice(2, 3); // Lấy ngày từ vị trí 2 trong chuỗi
                            }
                            // Kiểm tra định dạng dd/m/yyyy
                            else if (day.length === 9 && day.indexOf("/") === 2) {
                                daydate = day.slice(3, 4); // Lấy ngày từ vị trí 3 trong chuỗi
                            }
                            // Kiểm tra định dạng d/m/yyyy
                            else if (day.length === 8 && day.indexOf("/") === 1) {
                                daydate = day.slice(2, 3); // Lấy ngày từ vị trí 2 trong chuỗi
                            }
                            // Kiểm tra định dạng dd/m/yyyy hoặc d/mm/yyyy
                            else if (day.length === 8 && day.indexOf("/") === 2) {
                                daydate = day.slice(3, 4); // Lấy ngày từ vị trí 3 trong chuỗi
                            }

                            // console.log("Ngày là: " + daydate);

                            dayIndex = daydate - z;
                            if (dayIndex < 0) {
                                dayData[biengancuaIndex] = value;
                                biengancuaIndex += 1;
                                // console.log("Bien: " + biengancuaIndex);
                            }

                            else {
                                dayData[dayIndex] = value;
                                biengancuaIndex = dayIndex + 1;
                                // console.log("Bien: " + dayIndex);
                            }
                        }

                    );
                    weeklyChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: data.label,
                                data: dayData,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                function DrawWeeklyOverviewChart() {
                    $.ajax({
                        url: 'https://localhost:7042/api/Chart/weekly',
                        method: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            // console.log(data);
                            if (data && data.labels && data.values && data.label) {
                                DrawWeeklyChart(data);

                            } else {
                                console.error('Invalid data received from API');
                            }
                        },
                        error: function (error) {
                            console.error('Error fetching data:', error);
                        }
                    });
                }

                //Top 5 product
                function DrawTrendingProductsChart(data) {
                    var currentDay = new Date();

                    const ctx = document.getElementById('weeklyChartview').getContext('2d');

                    if (trendingProductsChart) {
                        trendingProductsChart.destroy();
                    }

                    // Mảng chứa dữ liệu của 15 ngày gần nhất cho mỗi sản phẩm
                    var datasets = [];
                    var dayData = new Array(15).fill(0);

                    // Mảng chứa nhãn của 15 ngày gần nhất với định dạng ngày/tháng
                    var labels = [];
                    for (var i = 14; i >= 0; i--) {
                        var date = new Date(currentDay);
                        date.setDate(currentDay.getDate() - i);

                        var day = date.getDate();
                        var month = date.getMonth() + 1;

                        // Định dạng ngày và tháng thành "dd/mm" và thêm vào mảng labels
                        var formattedDate = `${day < 10 ? '0' : ''}${day}/${month < 10 ? '0' : ''}${month}`;
                        labels.push(formattedDate);
                    }

                    // Ánh xạ dữ liệu từ API vào mảng của 15 ngày gần nhất cho mỗi sản phẩm
                    data.datasets.forEach(function (dataset) {
                        var productData = new Array(15).fill(0);

                        dataset.data.forEach(function (value, index) {
                            productData[index] = value;
                        });

                        datasets.push({
                            label: dataset.label,
                            data: productData,
                            borderWidth: 1,
                            borderColor: getRandomColor(), // Màu sắc ngẫu nhiên cho mỗi đường biểu đồ
                        });
                    });

                    trendingProductsChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: datasets,
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }

                // Hàm để tạo màu ngẫu nhiên
                function getRandomColor() {
                    var letters = '0123456789ABCDEF';
                    var color = '#';
                    for (var i = 0; i < 6; i++) {
                        color += letters[Math.floor(Math.random() * 16)];
                    }
                    return color;
                }

                function DrawTrendingProducts() {
                    $.ajax({
                        url: 'https://localhost:7042/api/Chart/TopProduct',
                        method: 'GET',
                        dataType: 'json',
                        success: function (data) {
                            console.log(data);
                            if (data && data.labels && data.datasets) {
                                DrawTrendingProductsChart(data);
                            } else {
                                console.error('Invalid data received from API');
                            }
                        },
                        error: function (error) {
                            console.error('Error fetching data:', error);
                        }
                    });
                }


                // Danh sách sản phẩm
                $(document).ready(
                    sortBy('quantity'));
            
                function sortBy(option) {
                    // Gọi API với tùy chọn sắp xếp tương ứng
                    var apiUrl = 'https://localhost:7042/api/Chart/SoldProductsByMonth?sortBy=' + option;

                    $.ajax({
                        url: apiUrl,
                        method: 'GET',
                        success: function (data) {
                            // Kiểm tra dữ liệu trong console log
                            // console.log(data);

                            // Xử lý dữ liệu và cập nhật HTML
                            var tableBody = $('#productTable tbody');
                            tableBody.empty();

                            // Kiểm tra cấu trúc dữ liệu để xác định tên thuộc tính
                            var productNameKey = 'ProductName';
                            var quantitySoldKey = 'QuantitySold';
                            var totalEarningsKey = 'TotalEarnings';
                            var imageProductKey = 'ProductImage';  // Điều chỉnh tên thuộc tính hình ảnh

                            // Sử dụng $.each để lặp qua mảng dữ liệu
                            $.each(data.labels, function (index, productName) {
                                var quantitySold = data.quantities[index];
                                var totalEarnings = data.earnings[index];
                                var imageProduct = data.images[index];  // Điều chỉnh tên thuộc tính hình ảnh

                                // Hiển thị thông tin sản phẩm trong bảng
                                var row = '<tr>' +
                                    '<td><img src="/images/' + imageProduct.trim() + '" alt="Product Image" width="90px" height="90px"></td>' +
                                    '<td>' + productName + '</td>' +
                                    '<td>' + quantitySold + '</td>' +
                                    '<td>' + totalEarnings + '</td>' +
                                    '</tr>';

                                tableBody.append(row);
                            });
                        },
                        error: function (error) {
                            // Xử lý lỗi nếu có
                            console.error('Error fetching data:', error);
                        }
                    });
                }
            });
        </script>
    </div>

</div>


